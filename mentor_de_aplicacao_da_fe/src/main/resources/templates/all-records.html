<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Semente - Todos os Registros</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Open+Sans:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <style>
      /* Paleta */
      :root {
        --cor-principal: #5e548e;
        --cor-acento: #ffc107;
        --cor-fundo: #f7f9fc;
        --cor-secundaria: #e1bee7;
        --cor-texto: #333333;
        --cor-reflexao: #f0f8ff;
        --cor-conselhos-bg: #fff8e1;
        --cor-conselho-item-bg: #ffffff;
      }
      body {
        font-family: "Open Sans", sans-serif;
        background-color: var(--cor-fundo);
        color: var(--cor-texto);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      .section-title {
        font-family: "Lora", serif;
        color: var(--cor-principal);
        font-weight: 700;
      }
      .container {
        max-width: 800px;
      }

      /* Header */
      .header-app {
        background-color: var(--cor-principal);
        color: white;
        padding: 2.5rem 1rem;
        border-radius: 0 0 2rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        position: relative;
      }
      .logo-placeholder {
        font-size: 2.2rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo-placeholder i {
        color: var(--cor-acento);
        margin-right: 0.5rem;
        font-size: 1.8rem;
      }

      /* Card Lista */
      .card-mentor {
        border: none;
        border-radius: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        background-color: white;
      }
      .badge-theme {
        background-color: #e3f2fd;
        color: var(--cor-principal);
        font-size: 0.9rem;
        padding: 0.6em 1em;
        border-radius: 50px;
        font-weight: 600;
      }
      .btn-action {
        background-color: var(--cor-principal);
        color: white;
        border-radius: 50px;
        padding: 0.5rem 1.25rem;
        font-weight: 600;
        transition: all 0.3s;
        text-decoration: none;
        border: none;
      }
      .btn-action:hover {
        background-color: #4a4072;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        color: white;
      }
      .list-header {
        background-color: var(--cor-secundaria);
        border-radius: 1rem 1rem 0 0;
        padding: 1rem 1.5rem;
      }
      .list-item-content {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        display: block;
        flex-grow: 1;
      }
      .record-clickable-area {
        cursor: pointer;
        min-width: 0;
        flex-grow: 1;
        padding-right: 0;
        transition: background-color 0.15s;
        border-radius: 0.5rem;
      }
      .record-clickable-area:hover {
        background-color: var(--cor-reflexao);
      }
      .record-clickable-area > div {
        max-width: 100%;
        min-width: 0;
      }

      /* Footer */
      .app-footer {
        border-top: 1px solid #e0e0e0;
        background-color: white;
        color: #777;
        padding: 2rem 0 1rem;
      }
      .footer-link {
        color: var(--cor-principal);
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
      }
      .footer-link:hover {
        color: var(--cor-acento);
      }

      /* Modal Detalhes */
      .versiculo-bussola {
        background-color: var(--cor-reflexao);
        border-radius: 1rem;
        font-style: italic;
        font-weight: 600;
        line-height: 1.6;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        padding: 1rem;
        text-align: center;
      }
      .conselhos-praticos-modal {
        background-color: var(--cor-conselhos-bg);
        border-left: 5px solid var(--cor-acento);
        border-radius: 0.5rem;
        padding: 1rem 1.5rem;
      }
      .conselhos-praticos-modal ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
      }
      /* ****** INÍCIO DA CORREÇÃO (Estilo Item Conselho Modal) ****** */
      .conselho-item-modal {
        background-color: var(--cor-conselho-item-bg);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        border: 1px solid #eee;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        font-family: "Open Sans", sans-serif;
        line-height: 1.6;
      }
      .conselhos-praticos-modal li:last-child .conselho-item-modal {
        margin-bottom: 0;
      }
      /* ****** FIM DA CORREÇÃO ****** */

      /* Mobile */
      @media (max-width: 768px) {
        .container {
          max-width: 100%;
          padding-left: 1rem;
          padding-right: 1rem;
        }
        .header-app {
          padding: 1.5rem 1rem;
          border-radius: 0 0 1rem 1rem;
        }
        .logo-placeholder {
          font-size: 1.8rem;
        }
        .list-group-item {
          flex-direction: column;
          align-items: stretch !important;
        }
        .record-clickable-area {
          margin-bottom: 0.5rem;
        }
        .list-group-item > div:last-child {
          align-items: center !important;
          flex-direction: row;
          justify-content: space-between;
          margin-top: 0.5rem;
          width: 100%;
        }
        .list-item-content {
          white-space: normal;
          overflow: visible;
          text-overflow: clip;
          font-size: 0.9rem;
        }
        .badge-theme {
          padding: 0.4em 0.7em;
          font-size: 0.75rem;
        }
        .list-header {
          padding: 0.75rem 1rem;
          font-size: 0.85rem;
        }
        /* ****** INÍCIO DA CORREÇÃO (Item Conselho Modal Mobile) ****** */
        .conselho-item-modal {
          padding: 0.6rem 0.8rem;
          font-size: 0.9rem;
        }
        /* ****** FIM DA CORREÇÃO ****** */
      }
    </style>
  </head>

  <body>
    <div class="header-app text-center">
      <div class="logo-placeholder mb-2">
        <i class="fa-solid fa-seedling"></i> SEMENTE
      </div>
      <h1 class="h3 fw-bold mb-0">Arquivo de Registros</h1>
      <p class="mb-0 fs-6 text-light opacity-75">
        Sua jornada completa, do início ao fim.
      </p>
    </div>

    <div class="container pb-5">
      <div class="text-center mb-4 mt-3 d-flex justify-content-center gap-3">
        <a th:href="@{/dashboard}" class="btn-action"
          ><i class="fa-solid fa-arrow-left me-2"></i> Voltar para o
          Dashboard</a
        >
        <form th:action="@{/logout}" method="post">
          <button
            type="submit"
            class="btn btn-sm btn-outline-danger"
            style="
              border-radius: 50px;
              padding: 0.5rem 1rem;
              font-weight: 600;
              border-color: #dc3545;
              color: #dc3545;
            "
          >
            <i class="fas fa-sign-out-alt me-2"></i> Sair
          </button>
        </form>
      </div>

      <div
        th:if="${successMessage}"
        class="alert alert-success alert-dismissible fade show card-mentor"
        role="alert"
      >
        <span th:text="${successMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <div
        th:if="${errorMessage}"
        class="alert alert-danger alert-dismissible fade show card-mentor"
        role="alert"
      >
        <span th:text="${errorMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>

      <h2 class="h4 fw-bold text-center mb-4 mt-4">
        Lista Completa de Aplicações
      </h2>

      <div
        th:if="${#lists.isEmpty(applications)}"
        class="text-center p-4 text-muted"
      >
        <p class="mb-0">Não há registros salvos para análise.</p>
      </div>

      <div
        th:unless="${#lists.isEmpty(applications)}"
        class="card card-mentor p-0"
      >
        <div
          class="list-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0 fw-bold text-white">Desafio</h5>
        </div>
        <ul class="list-group list-group-flush">
          <li
            th:each="app : ${applications}"
            class="list-group-item d-flex justify-content-between align-items-start p-3"
          >
            <div
              class="record-clickable-area d-flex align-items-center min-w-0 flex-grow-1"
              th:data-app-id="${app.id}"
              onclick="showRecordDetail(this.getAttribute('data-app-id'))"
            >
              <div class="d-flex flex-column min-w-0 flex-grow-1">
                <div class="d-flex align-items-center mb-1 min-w-0 flex-grow-1">
                  <span
                    class="badge bg-light text-primary-emphasis me-2 flex-shrink-0"
                    th:text="${app.id}"
                  ></span>
                  <span
                    class="fw-semibold list-item-content"
                    th:text="${app.userChallenge}"
                  ></span>
                </div>
                <div class="d-flex flex-wrap mt-1">
                  <span
                    th:each="theme : ${#strings.arraySplit(app.identifiedTheme, ',')}"
                    class="badge badge-theme me-1 mb-1 small"
                    th:text="${#strings.trim(theme)}"
                  ></span>
                </div>
              </div>
            </div>
            <div class="d-flex flex-column align-items-end ms-3 flex-shrink-0">
              <small
                class="text-muted mb-2"
                th:text="${#temporals.format(app.createdAt, 'dd/MM/yy HH:mm')}"
              ></small>
              <button
                class="btn btn-sm btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#deleteConfirmationModal"
                th:data-app-id="${app.id}"
                title="Excluir Permanentemente"
              >
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <footer class="app-footer text-center">
      <div class="container">
        <p class="mb-3 small">
          ©
          <span th:text="${#dates.year(#dates.createNow())}">2024</span> Semente
          - Mentor de Aplicação da Fé.
        </p>
        <div class="mb-3">
          <a href="#" class="footer-link mx-2 small">Sobre</a> |
          <a href="#" class="footer-link mx-2 small">Contato</a> |
          <a href="#" class="footer-link mx-2 small">Política de Privacidade</a>
        </div>
        <p class="small text-muted fst-italic">
          Criado para inspirar reflexão e ação diária.
        </p>
      </div>
    </footer>

    <div
      class="modal fade"
      id="recordDetailModal"
      tabindex="-1"
      aria-labelledby="recordDetailModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div
            class="modal-header"
            style="background-color: var(--cor-principal); color: white"
          >
            <h5 class="modal-title" id="recordDetailModalLabel">
              Mentoria Completa #<span id="detailAppId"></span>
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <h6 class="fw-bold text-muted mb-2">
                <i class="fa-solid fa-user-circle me-2"></i> Seu Desafio
                Original
              </h6>
              <p
                id="detailUserChallenge"
                class="alert alert-secondary border-start border-5 border-secondary ps-3"
                style="white-space: pre-wrap"
              ></p>
            </div>
            <div class="mb-4">
              <h6 class="fw-bold text-dark">
                <i class="fa-solid fa-tag me-2"></i> Tema Identificado
              </h6>
              <span id="detailIdentifiedTheme"></span>
            </div>
            <div class="mb-4">
              <h6 class="fw-bold text-dark">
                <i class="fa-solid fa-compass me-2"></i> 1. O Versículo-Bússola
              </h6>
              <p
                id="detailVersiculoBussola"
                class="p-3 rounded-3 versiculo-bussola"
              ></p>
            </div>
            <div class="mb-4">
              <h6 class="fw-bold text-dark">
                <i class="fa-solid fa-lightbulb me-2"></i> 2. A Reflexão
                Aplicada
              </h6>
              <p id="detailReflexaoAplicada" class="card-text"></p>
            </div>
            <div class="mb-4 conselhos-praticos-modal">
              <h6 class="fw-bold text-dark">
                <i class="fa-solid fa-shoe-prints me-2"></i> 3. Conselhos
                Práticos (Ação)
              </h6>
              <div id="detailConselhosPraticos"></div>
            </div>
            <div class="mb-4">
              <h6 class="fw-bold text-dark">
                <i class="fa-solid fa-book-open me-2"></i> 4. Referências
                Cruzadas
              </h6>
              <p
                id="detailReferenciasCruzadas"
                class="card-text small text-muted"
              ></p>
            </div>
            <div class="mb-0 p-3 rounded-3" style="background-color: #f3e5f5">
              <h6 class="fw-bold text-dark mb-2">
                <i class="fa-solid fa-hands-praying me-2"></i> 5. Oração-Semente
              </h6>
              <p id="detailOracaoSemente" class="card-text fst-italic"></p>
            </div>
            <div class="mt-4 text-end">
              <small class="text-muted"
                >Registrado em: <span id="detailCreatedAt"></span
              ></small>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fechar Detalhes
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="deleteConfirmationModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteConfirmationModalLabel">
              <i class="fas fa-exclamation-triangle me-2"></i> Confirmação
              Necessária
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-center">
            <p class="mb-3">
              Você tem certeza que deseja excluir este registro?
            </p>
            <p class="text-danger small">
              Esta ação não pode ser desfeita e irá afetar seu Mapa de
              Crescimento.
            </p>
            <form id="deleteForm" method="post" action="/delete/0">
              <input type="hidden" name="_method" value="delete" />
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-danger fw-bold">
                  Sim, Excluir Definitivamente
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      const DELETE_BASE_PATH = /*[[@{/delete/}]]*/ "/delete/";
      const RECORD_DETAIL_BASE_PATH = /*[[@{/record/}]]*/ "/record/";

      async function showRecordDetail(appId) {
        const detailModalElement = document.getElementById("recordDetailModal");
        const detailModal = new bootstrap.Modal(detailModalElement);

        // Limpar e mostrar carregando
        document.getElementById("detailAppId").textContent = appId;
        const fieldsToClear = [
          "detailUserChallenge",
          "detailVersiculoBussola",
          "detailReflexaoAplicada",
          "detailReferenciasCruzadas",
          "detailOracaoSemente",
          "detailCreatedAt",
        ];
        fieldsToClear.forEach(
          (id) => (document.getElementById(id).textContent = "Carregando...")
        );
        document.getElementById(
          "detailIdentifiedTheme"
        ).innerHTML = `<span class="text-muted small">Carregando...</span>`;
        document.getElementById("detailConselhosPraticos").innerHTML =
          '<p class="text-muted small">Carregando...</p>';

        try {
          const response = await fetch(RECORD_DETAIL_BASE_PATH + appId);
          if (!response.ok)
            throw new Error("Registro não encontrado ou erro de servidor.");
          const app = await response.json();

          // Preencher campos
          document.getElementById("detailUserChallenge").textContent =
            app.userChallenge;
          document.getElementById("detailVersiculoBussola").textContent =
            app.versiculoBussola;

          const formatTextToHtml = (text) =>
            text ? text.replace(/\n/g, "<br>") : "N/A";
          document.getElementById("detailReflexaoAplicada").innerHTML =
            formatTextToHtml(app.reflexaoAplicada);
          document.getElementById("detailReferenciasCruzadas").textContent =
            app.referenciasCruzadas || "N/A";
          document.getElementById("detailOracaoSemente").innerHTML =
            formatTextToHtml(app.oracaoSemente);

          // ****** INÍCIO DA CORREÇÃO (Renderizar Conselhos como Itens Separados no Modal) ******
          const conselhosContainer = document.getElementById(
            "detailConselhosPraticos"
          );
          conselhosContainer.innerHTML = ""; // Limpa

          if (app.conselhosPraticos && app.conselhosPraticos.trim() !== "") {
            const conselhosArray = app.conselhosPraticos.split("\n");
            const listElement = document.createElement("ul");

            conselhosArray.forEach((conselho) => {
              if (conselho.trim() !== "") {
                const listItem = document.createElement("li");
                // Cria o div interno estilizado
                const itemDiv = document.createElement("div");
                itemDiv.className = "conselho-item-modal"; // Usa a classe CSS definida
                itemDiv.textContent = conselho;
                // Adiciona o div ao li
                listItem.appendChild(itemDiv);
                // Adiciona o li à lista ul
                listElement.appendChild(listItem);
              }
            });
            conselhosContainer.appendChild(listElement);
          } else {
            conselhosContainer.innerHTML =
              '<p class="text-muted small fst-italic">Nenhum conselho prático gerado.</p>';
          }
          // ****** FIM DA CORREÇÃO ******

          // Data
          const date = new Date(app.createdAt);
          const pad = (num) => num.toString().padStart(2, "0");
          const formattedDate = `${pad(date.getDate())}/${pad(
            date.getMonth() + 1
          )}/${date.getFullYear()} ${pad(date.getHours())}:${pad(
            date.getMinutes()
          )}`;
          document.getElementById("detailCreatedAt").textContent =
            formattedDate;

          // Temas
          const themesHtml = app.identifiedTheme
            ? app.identifiedTheme
                .split(",")
                .map(
                  (t) =>
                    `<span class="badge badge-theme me-1">${t.trim()}</span>`
                )
                .join("")
            : `<span class="text-muted small">Nenhum</span>`;
          document.getElementById("detailIdentifiedTheme").innerHTML =
            themesHtml;

          detailModal.show();
        } catch (error) {
          console.error("Erro ao carregar detalhes:", error);
          alert("Erro ao carregar detalhes. Verifique o console.");
          // Limpar campos em caso de erro (opcionalmente mostrar erro)
          fieldsToClear.forEach(
            (id) => (document.getElementById(id).textContent = "Erro")
          );
          document.getElementById(
            "detailIdentifiedTheme"
          ).innerHTML = `<span class="text-danger small">Erro</span>`;
          document.getElementById("detailConselhosPraticos").innerHTML =
            '<p class="text-danger small">Erro.</p>';
        }
      }

      // Lógica Modal Exclusão
      document.addEventListener("DOMContentLoaded", function () {
        const deleteConfirmationModal = document.getElementById(
          "deleteConfirmationModal"
        );
        const deleteForm = document.getElementById("deleteForm");
        deleteConfirmationModal.addEventListener(
          "show.bs.modal",
          function (event) {
            const clickedElement = event.relatedTarget;
            const button = clickedElement.closest("button");
            const appId = button ? button.getAttribute("data-app-id") : null;
            deleteForm.action = DELETE_BASE_PATH + appId;
          }
        );
      });
      /*]]>*/
    </script>
  </body>
</html>
